<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~    Copyright 2021 Huawei Technologies Co., Ltd.
  ~
  ~    Licensed under the Apache License, Version 2.0 (the "License");
  ~    you may not use this file except in compliance with the License.
  ~    You may obtain a copy of the License at
  ~
  ~        http://www.apache.org/licenses/LICENSE-2.0
  ~
  ~    Unless required by applicable law or agreed to in writing, software
  ~    distributed under the License is distributed on an "AS IS" BASIS,
  ~    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~    See the License for the specific language governing permissions and
  ~    limitations under the License.
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.edgegallery.developer.mapper.application.vm.VMInstantiateInfoMapper">
<!--  <resultMap id="VMInstantiateInfoMap" type="org.edgegallery.developer.model.instantiate.vm.VMInstantiateInfo">-->
<!--    <result property="appPackageId" column="app_package_id"/>-->
<!--    <result property="appInstanceId" column="app_instance_id"/>-->
<!--    <result property="vmInstanceId" column="vm_instance_id"/>-->
<!--    <result property="status" column="status"/>-->
<!--    <result property="log" column="log"/>-->
<!--    <result property="vncUrl" column="vnc_url"/>-->
<!--    <result property="instantiateTime" column="instantiate_time"/>-->
<!--  </resultMap>-->

<!--  <resultMap id="PortInstantiateInfoMap" type="org.edgegallery.developer.model.instantiate.vm.PortInstantiateInfo">-->
<!--    <id property="networkName" column="network_name"/>-->
<!--    <result property="ipAddress" column="ip_address"/>-->
<!--  </resultMap>-->

  <resultMap id="VMInstantiateInfoMap" type="org.edgegallery.developer.model.instantiate.vm.VMInstantiateInfo">
    <result property="appPackageId" column="app_package_id"/>
    <result property="appInstanceId" column="app_instance_id"/>
    <result property="vmInstanceId" column="vm_instance_id"/>
    <result property="status" column="status"/>
    <result property="log" column="log"/>
    <result property="vncUrl" column="vnc_url"/>
    <result property="instantiateTime" column="instantiate_time"/>
    <collection property="portInstanceList"
      ofType="org.edgegallery.developer.model.instantiate.vm.PortInstantiateInfo">
      <result property="networkName" column="network_name"/>
      <result property="ipAddress" column="ip_address"/>
    </collection>
  </resultMap>

<!--  <sql id="VMInstantiateInfoColumn">-->
<!--    vm_id, app_package_id, app_instance_id, vm_instance_id, status, log, vnc_url, instantiate_time-->
<!--  </sql>-->

  <sql id="VMInstantiateInfoAllColumn">
    a.vm_id, a.app_package_id, a.app_instance_id, a.vm_instance_id, a.status, a.log, a.vnc_url,
    a.instantiate_time, b.network_name, b.ip_address
  </sql>

  <insert id="createVMInstantiateInfo">
    insert into tbl_vm_instantiate_info (vm_id, app_package_id, app_instance_id, vm_instance_id, status, log, vnc_url, instantiate_time)
    values
    ( #{vmId}, #{vmInstantiateInfo.appPackageId}, #{vmInstantiateInfo.appInstanceId}, #{vmInstantiateInfo.vmInstanceId},
    #{vmInstantiateInfo.status}, #{vmInstantiateInfo.log}, #{vmInstantiateInfo.vncUrl},  #{vmInstantiateInfo.instantiateTime})
  </insert>

  <update id="modifyVMInstantiateInfoByVMId">
    UPDATE
    tbl_vm_instantiate_info
    SET
    app_package_id = #{vmInstantiateInfo.appPackageId}, app_instance_id = #{vmInstantiateInfo.appInstanceId},
    vm_instance_id = #{vmInstantiateInfo.vmInstanceId}, status = #{vmInstantiateInfo.status}, log = #{vmInstantiateInfo.log},
    vnc_url = #{vmInstantiateInfo.vncUrl}, instantiate_time = #{vmInstantiateInfo.instantiateTime}
    WHERE
    vm_id = #{vmId}
  </update>

  <delete id="deleteVMInstantiateInfoByVMId" parameterType="String">
    DELETE FROM tbl_vm_instantiate_info WHERE vm_id = #{vmId};
    DELETE FROM tbl_vm_port_instantiate_info WHERE vm_id = #{vmId};
  </delete>

  <select id="getVMInstantiateInfo" parameterType="String" resultMap="VMInstantiateInfoMap">
    SELECT
    <include refid="VMInstantiateInfoAllColumn"/>
    from tbl_vm_instantiate_info a, tbl_vm_port_instantiate_info b
    where a.vm_id=b.vm_id and b.vm_id=#{vmId} and a.vm_id=#{vmId}
    order by a.vm_id
  </select>

  <insert id="createPortInstantiateInfo">
    insert into tbl_vm_port_instantiate_info (vm_id, network_name, ip_address)
    values
    ( #{vmId}, #{portInstantiateInfo.networkName}, #{portInstantiateInfo.ipAddress})
  </insert>

  <delete id="deletePortInstantiateInfoByVMId" parameterType="String">
    DELETE FROM tbl_vm_port_instantiate_info WHERE vm_id = #{vmId};
  </delete>

</mapper>